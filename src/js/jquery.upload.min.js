"use strict";!function(e){function t(t,s){this.element=t,this.settings=e.extend({},n,s),this._defaults=n,this._name=i,this.complete=!0,this.code=0,this.msg="",this.init()}var i="ajaxImageUpload",n={fileInput:"",postUrl:"",width:150,height:150,imageUrl:[],postData:{},allowZoom:!0,allowType:["gif","jpeg","jpg","bmp","png"],maxNum:5,maxSize:1,appendMethod:"before",before:e.noop,success:e.noop,error:e.noop,complete:e.noop};t.prototype={init:function(){var t=this,i=e(this.element),n=t.settings.imageUrl;if(t.createSectionBox(),n.length>0)for(var s=0;s<n.length;s++)t.createImageSection(n[s]);i.find("input[type=file]").on("change",function(){t.selectFile()})},selectFile:function(){var t=this,i=e(this.element),n=t.settings.maxNum,s=t.settings.maxSize,o=t.settings.postUrl,a=t.settings.fileInput,r=t.settings.before,l=t.settings.complete,c=i.find("input[type=file]"),g=i.find(".ggy-image-section");if(!o)return t.callError("300","没有配置postUrl"),t.resetFile(),!1;if(!a)return t.callError("301","没有配置fileInput"),t.resetFile(),!1;if(r&&!1===r())return t.resetFile(),!1;var p=c[0].files;if(p.length+g.length>n)return t.callError("302","上传图片数目不能超过"+n+"个"),t.resetFile(),!1;for(var d=0;d<p.length;d++){var f=p[d];if(!t.isAllowFile(f)){t.callError("303",f.name+" 图片类型不支持"),t.resetFile();break}if(t.getFileSize(f)>s){t.callError("304","上传图片不能超过"+s+"M，当前上传图片的大小为"+$fileSize.toFixed(2)+"M"),t.resetFile();break}t.createImageSection(),t.ajaxUpload(f)}1==t.complete&&l(),t.resetFile()},createSectionBox:function(){var t=this,i=e(this.element),n=t.settings.fileInput,s=e("<div class='ggy-section-box'></div>"),o=e("<section class='ggy-upload-section'></section>"),a=e("<section class='ggy-modal-section'></section>"),r=e("<i class='ggy-upload-icon'></i>"),l=e("<input type='file' name='"+n+"' class='ggy-upload-input' accept='image/*' multiple='multiple'>");s.appendTo(i),o.appendTo(s),r.appendTo(o),l.appendTo(o),a.appendTo(s),a.on("click",function(e){e.stopPropagation(),a.hide()})},createImageSection:function(t){var i=this,n=e(this.element),s=i.settings.width,o=i.settings.height,a=i.settings.fileInput,r=i.settings.allowZoom,l=i.settings.appendMethod,c=n.find(".ggy-section-box"),g=n.find(".ggy-upload-section"),p=e("<section class='ggy-image-section loading'></section>"),d=e("<div class='ggy-image-shade'></div>"),f=e("<input type='hidden' name='"+a+"[]' value='"+t+"'>"),m=e("<img class='ggy-image-show shade' src='"+t+"'/>");switch(t&&(m=e("<img class='ggy-image-show' src='"+t+"'/>")),p.css({width:s,height:o}),g.css({width:s,height:o}),l){case"before":c.prepend(p);break;case"after":g.before(p)}f.appendTo(p),m.appendTo(p),d.appendTo(p),i.createDeleteNode(p),t&&!0===r&&i.createZoomNode(p)},createDeleteNode:function(t){var i=e(this.element),n=i.find(".ggy-modal-section"),s=e("<i class='ggy-delete-icon'></i>"),o=e("<div class='ggy-modal-box ggy-delete-box'><p class='ggy-delete-tip'>您确定要删除吗？</p><p class='ggy-delete-btn'> <span class='ggy-confirm-btn'>确定</span><span class='ggy-cancel-btn'>取消</span></p></div>");s.appendTo(t),t.find(".ggy-delete-icon").on("click",function(e){e.stopPropagation(),n.html(o),n.show()}),o.find(".ggy-confirm-btn").on("click",function(e){e.stopPropagation(),n.hide(),t.remove(),o.remove()}),o.find(".ggy-cancel-btn").on("click",function(e){return e.stopPropagation(),n.hide(),!1})},createZoomNode:function(t){var i=e(this.element),n=t.find(".ggy-image-show"),s=i.find(".ggy-modal-section"),o=e("<i class='ggy-zoom-icon'></i>"),a=e("<div class='ggy-modal-box ggy-zoom-box'><img src=''/></div>");a.find("img").attr("src",n.attr("src")),o.appendTo(t),t.find(".ggy-zoom-icon").on("click",function(e){e.stopPropagation(),s.html(a),s.show()})},ajaxUpload:function(t){var i=this,n=e(this.element),s=i.settings.fileInput,o=i.settings.postData,a=i.settings.postUrl,r=i.settings.allowZoom,l=i.settings.success;switch(i.settings.appendMethod){case"before":var c=n.find(".ggy-image-section:first"),g=n.find(".ggy-image-show:first");break;case"after":var c=n.find(".ggy-image-section:last"),g=n.find(".ggy-image-show:last")}var p=new FormData;p.append(s,t);for(var d in o)p.append(d,o[d]);e.ajax({url:a,type:"post",async:!1,data:p,processData:!1,contentType:!1,dataType:"json",mimeType:"multipart/form-data",success:function(e){if(200!=e.code)return i.callError(e.code,e.msg),c.remove(),!1;g.removeClass("shade").attr("src",e.src),c.find("input[type=hidden]").val(e.src),!0===r&&i.createZoomNode(c),i.complete*=!0,l(e)},error:function(e,t,n){i.callError(e.status,"AjaxUrl Service Error:"+e.statusText),c.remove()}})},isAllowFile:function(t){var i=this.settings.allowType,n=this.getFileExt(t);return-1!=e.inArray(n,i)},getFileExt:function(e){var t=e.name,i=t.lastIndexOf(".");return i<1?"":t.substr(i+1).toLowerCase()},getFileSize:function(e){return e.size/1048576},resetFile:function(){e(this.element).find("input[type=file]").val(null)},callError:function(e,t){var i=this,n=i.settings.error;i.complete*=!1,i.code=e,i.msg=t,n(i)}},e.fn[i]=function(n){return this.each(function(){e.data(this,"plugin_"+i)||e.data(this,"plugin_"+i,new t(this,n))})}}(jQuery,window,document);
